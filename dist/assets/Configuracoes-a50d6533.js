import{c as B,B as H,r as v,F as S,j as a,L as C,G as U,H as P,I as T,K as A,U as q,S as b,C as w,E as f,aa as W}from"./index-a996d77c.js";import{X as Y,u as J,w as Z}from"./xlsx-81fdaaba.js";import{F as Q}from"./file-spreadsheet-53adb39f.js";import{A as V}from"./alert-triangle-3be795c1.js";import{T as ee}from"./trash-2-99337be2.js";const ae=B("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]),ne=()=>{const{toast:t}=H(),[e,k]=v.useState(JSON.parse(localStorage.getItem(S))),[y,D]=v.useState(""),[x,E]=v.useState((e==null?void 0:e.storeName)||""),[_,F]=v.useState((e==null?void 0:e.cnpj)||""),[p,$]=v.useState(!1),[m,g]=v.useState(!1);v.useEffect(()=>{const o=JSON.parse(localStorage.getItem(S));k(o),E((o==null?void 0:o.storeName)||""),F((o==null?void 0:o.cnpj)||"")},[]),v.useEffect(()=>{(async()=>{var n,l,c;if(!(!e||!e.id||!e.cnpj)){$(!0);try{const{data:s,error:r}=await f.from("loja_configuracoes").select("*").eq("user_id",e.id).eq("cnpj",e.cnpj).single();r&&r.code!=="PGRST116"&&((n=r.message)!=null&&n.includes("406")||t({title:"Erro ao Carregar Configurações",description:r.message,variant:"destructive"})),s?(E(s.nome_loja||e.storeName),D(s.url_logo||"")):(E(e.storeName||""),D(""))}catch(s){!((l=s.message)!=null&&l.includes("406"))&&!((c=s.message)!=null&&c.includes("Failed to fetch"))&&t({title:"Erro ao Carregar Configurações",description:s.message,variant:"destructive"})}finally{$(!1)}}})()},[t,e]);const R=async o=>{var l,c,s;const n=o.target.files[0];if(!n||!e||!e.id||!e.cnpj){t({title:"Erro",description:"Selecione um arquivo e certifique-se que está logado.",variant:"destructive"});return}if(!n.type.startsWith("image/")){t({title:"Erro",description:"Por favor, selecione um arquivo de imagem.",variant:"destructive"});return}g(!0);try{const r=`${e.id}/${e.cnpj}-${Date.now()}-${n.name.replace(/\s/g,"_")}`,{error:i}=await f.storage.from("logos-lojas").upload(r,n,{cacheControl:"3600",upsert:!1});if(i)throw i;const{data:d}=f.storage.from("logos-lojas").getPublicUrl(r),u=d.publicUrl;D(u);const{error:j}=await f.from("loja_configuracoes").upsert({user_id:e.id,cnpj:e.cnpj,url_logo:u,nome_loja:x},{onConflict:"user_id, cnpj"});j?(l=j.message)!=null&&l.includes("406")||t({title:"Erro ao Salvar Logo",description:j.message,variant:"destructive"}):t({title:"Sucesso",description:"Logo atualizada."})}catch(r){!((c=r.message)!=null&&c.includes("400"))&&!((s=r.message)!=null&&s.includes("Failed to fetch"))&&t({title:"Erro no Upload da Logo",description:r.message,variant:"destructive"})}finally{g(!1)}},X=async()=>{var o,n,l,c,s;if(!e||!e.id||!e.cnpj){t({title:"Erro",description:"Usuário não autenticado.",variant:"destructive"});return}if(!x.trim()||!_.trim()){t({title:"Erro",description:"Nome da Loja e CNPJ são obrigatórios.",variant:"destructive"});return}g(!0);try{const{data:r,error:i}=await f.auth.updateUser({data:{store_name:x,cnpj:_}});if(i&&!((o=i.message)!=null&&o.includes("406"))){t({title:"Erro ao Atualizar Usuário",description:i.message,variant:"destructive"});return}const{error:d}=await f.from("loja_configuracoes").upsert({user_id:e.id,cnpj:_,nome_loja:x,url_logo:y},{onConflict:"user_id, cnpj"});if(d&&!((n=d.message)!=null&&n.includes("406"))){t({title:"Erro ao Salvar Configurações",description:d.message,variant:"destructive"});return}const{error:u}=await f.from("usuarios").update({nome_loja:x,cnpj:_}).eq("auth_user_id",e.id);u&&u.code!=="PGRST116"&&!((l=u.message)!=null&&l.includes("406"))&&console.warn("Aviso: Falha ao atualizar tabela 'usuarios'",u.message);const j={...e,storeName:x,cnpj:_};localStorage.setItem(S,JSON.stringify(j)),k(j),t({title:"Sucesso",description:"Configurações salvas."})}catch(r){!((c=r.message)!=null&&c.includes("406"))&&!((s=r.message)!=null&&s.includes("Failed to fetch"))&&t({title:"Erro ao Salvar Configurações",description:r.message,variant:"destructive"})}finally{g(!1)}},G=async()=>{var o,n,l,c;if(!e||!e.id||!e.cnpj){t({title:"Erro",description:"Usuário não autenticado.",variant:"destructive"});return}if(window.confirm(`TEM CERTEZA? Todos os dados associados ao CNPJ ${e.cnpj} (notas, inventário, configurações, etc.) serão apagados permanentemente. Esta ação não pode ser desfeita.`)){g(!0);try{const s=["notas_fiscais","inventario_fisico","desossas_registradas","parametros_rendimento_boi"];for(const i of s){const d=i==="notas_fiscais"?"cnpj_emitente":i==="inventario_fisico"?"cnpj_loja":"cnpj_empresa",{error:u}=await f.from(i).delete().eq("user_id",e.id).eq(d,e.cnpj);u&&!((o=u.message)!=null&&o.includes("406"))&&console.error(`Erro ao apagar ${i}:`,u.message)}const{error:r}=await f.from("loja_configuracoes").delete().eq("user_id",e.id).eq("cnpj",e.cnpj);r&&!((n=r.message)!=null&&n.includes("406"))&&console.error("Erro ao apagar config:",r.message),Object.keys(localStorage).forEach(i=>{i.startsWith(W+e.cnpj)&&localStorage.removeItem(i)}),t({title:"Dados Apagados",description:`Todos os dados do CNPJ ${e.cnpj} foram removidos.`,variant:"destructive"})}catch(s){!((l=s.message)!=null&&l.includes("406"))&&!((c=s.message)!=null&&c.includes("Failed to fetch"))&&t({title:"Erro ao Apagar Dados",description:s.message,variant:"destructive"})}finally{g(!1)}}},M=async()=>{var o,n,l;if(!e||!e.id||!e.cnpj){t({title:"Erro",description:"Usuário não autenticado.",variant:"destructive"});return}g(!0);try{const c={},s=["notas_fiscais","inventario_fisico","loja_configuracoes","desossas_registradas","parametros_rendimento_boi"];for(const d of s){const u=d==="notas_fiscais"?"cnpj_emitente":d==="inventario_fisico"?"cnpj_loja":d==="loja_configuracoes"?"cnpj":"cnpj_empresa",{data:j,error:h}=await f.from(d).select("*").eq("user_id",e.id).eq(u,e.cnpj);h&&h.code!=="PGRST116"&&!((o=h.message)!=null&&o.includes("406"))&&console.warn(`Erro ao exportar ${d}:`,h.message),c[d]=j||[]}c.auth_user_info=JSON.parse(localStorage.getItem(S));const r=`data:text/json;charset=utf-8,${encodeURIComponent(JSON.stringify(c,null,2))}`,i=document.createElement("a");i.href=r,i.download=`dados_app_${e.cnpj}_${new Date().toISOString().slice(0,10)}.json`,i.click(),t({title:"Dados Exportados",description:"Arquivo JSON baixado."})}catch(c){!((n=c.message)!=null&&n.includes("406"))&&!((l=c.message)!=null&&l.includes("Failed to fetch"))&&t({title:"Erro ao Exportar Dados",description:c.message,variant:"destructive"})}finally{g(!1)}},z=async o=>{const n=o.target.files[0];if(!n||!e||!e.id||!e.cnpj){t({title:"Erro",description:"Selecione arquivo e logue.",variant:"destructive"});return}if(n.type!=="application/json"){t({title:"Erro",description:"Selecione arquivo JSON.",variant:"destructive"});return}g(!0);const l=new FileReader;l.onload=async c=>{try{const s=JSON.parse(c.target.result);let r=0;const i=async(d,u,j,h=["id"])=>{var O;if(u&&u.length>0){const I=u.filter(N=>N[j]===e.cnpj).map(N=>({...N,user_id:e.id}));if(I.length>0){const N=Array.isArray(h)?h.join(","):h,{error:L}=await f.from(d).upsert(I,{onConflict:N});L&&!((O=L.message)!=null&&O.includes("406"))?console.warn(`Erro ao importar ${d}:`,L.message):r+=I.length}}};await i("notas_fiscais",s.notas_fiscais,"cnpj_emitente"),await i("inventario_fisico",s.inventario_fisico,"cnpj_loja"),await i("desossas_registradas",s.desossas_registradas,"cnpj_empresa"),await i("parametros_rendimento_boi",s.parametros_rendimento_boi,"cnpj_empresa"),await i("loja_configuracoes",s.loja_configuracoes,"cnpj","user_id,cnpj"),r>0?t({title:"Dados Importados",description:`${r} registros importados/atualizados. Recarregue.`}):t({title:"Importação Concluída",description:"Nenhum dado correspondente ao CNPJ.",variant:"default"})}catch(s){t({title:"Erro na Importação",description:`Detalhe: ${s.message}`,variant:"destructive"})}finally{g(!1),o.target.value=null}},l.readAsText(n)},K=()=>{if(typeof Y>"u"){t({title:"Erro",description:"Biblioteca de planilha (XLSX) não está disponível.",variant:"destructive"});return}const o=[["codigo_produto","nome_produto","quantidade_inicial","custo_unitario_entrada"],["EX001","Picanha KG",10.5,35.9],["EX002","Contra Filé KG",22.3,28.5],["EX003","Alcatra KG",15,30]],n=J.aoa_to_sheet(o),l=J.book_new();J.book_append_sheet(l,n,"ModeloInventario"),Z(l,"Modelo_Planilha_Inventario.xlsx"),t({title:"Download Iniciado",description:"Modelo de planilha baixado."})};return p&&!e?a.jsxs("div",{className:"flex justify-center items-center h-64",children:[a.jsx(C,{size:48})," ",a.jsx("p",{className:"ml-3",children:"Aguardando dados do usuário..."})]}):p&&e?a.jsxs("div",{className:"flex justify-center items-center h-64",children:[a.jsx(C,{size:48})," ",a.jsx("p",{className:"ml-3",children:"Carregando configurações..."})]}):a.jsxs("div",{className:"space-y-6",children:[a.jsx("h1",{className:"text-3xl font-bold",children:"Configurações da Conta e Loja"}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[a.jsxs(U,{className:"glass-card",children:[a.jsx(P,{children:a.jsx(T,{children:"Identidade da Loja"})}),a.jsxs(A,{className:"space-y-4",children:[a.jsxs("div",{children:[a.jsx(q,{htmlFor:"storeNameConfig",children:"Nome da Loja"}),a.jsx(b,{id:"storeNameConfig",value:x,onChange:o=>E(o.target.value),disabled:m||p})]}),a.jsxs("div",{children:[a.jsx(q,{htmlFor:"cnpjConfig",children:"CNPJ da Loja (para exibição e filtros)"}),a.jsx(b,{id:"cnpjConfig",value:_,onChange:o=>F(o.target.value),disabled:m||p})]}),a.jsxs("div",{children:[a.jsx(q,{htmlFor:"logoUploadConfig",children:"Logo da Loja"}),a.jsx(b,{id:"logoUploadConfig",type:"file",accept:"image/*",onChange:R,disabled:m||p}),y&&a.jsx("img",{src:y,alt:"Prévia da Logo",className:"mt-2 max-h-24 border p-1 rounded object-contain"})]}),a.jsxs(w,{onClick:X,disabled:m||p,children:[m||p?a.jsx(C,{className:"mr-2"}):null," Salvar Alterações"]})]})]}),a.jsxs(U,{className:"glass-card",children:[a.jsx(P,{children:a.jsx(T,{children:"Gerenciamento de Dados"})}),a.jsxs(A,{className:"space-y-4",children:[a.jsxs(w,{onClick:K,variant:"outline",className:"w-full",disabled:m||p,children:[a.jsx(Q,{className:"mr-2 h-4 w-4"})," Baixar Planilha Modelo (Inventário)"]}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"Este modelo é para a funcionalidade de importação de inventário via planilha (ainda em desenvolvimento)."}),a.jsxs("div",{className:"space-y-2 pt-4 border-t",children:[a.jsx("h4",{className:"font-semibold",children:"Exportar Dados"}),a.jsxs(w,{onClick:M,variant:"outline",className:"w-full",disabled:m||p,children:[m||p?a.jsx(C,{className:"mr-2"}):a.jsx(ae,{className:"mr-2 h-4 w-4"})," Exportar Dados (JSON)"]})]}),a.jsxs("div",{className:"space-y-2 pt-4 border-t",children:[a.jsx("h4",{className:"font-semibold",children:"Importar Dados"}),a.jsx(b,{type:"file",accept:".json",onChange:z,className:"w-full",disabled:m||p}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"Importe de JSON. Dados devem corresponder ao CNPJ atual."})]})]})]})]}),a.jsxs(U,{className:"glass-card border-destructive",children:[a.jsx(P,{children:a.jsxs(T,{className:"text-destructive flex items-center",children:[a.jsx(V,{className:"mr-2 h-5 w-5"})," Zona de Perigo"]})}),a.jsxs(A,{children:[a.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"A ação abaixo é irreversível."}),a.jsxs(w,{variant:"destructive",onClick:G,className:"w-full",disabled:m||p,children:[m||p?a.jsx(C,{className:"mr-2"}):a.jsx(ee,{className:"mr-2 h-4 w-4"})," Apagar Dados Deste CNPJ"]})]})]})]})};export{ne as default};
