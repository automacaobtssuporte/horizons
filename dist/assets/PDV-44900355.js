import{c as V,r as t,a5 as O,a6 as W,a7 as J,a8 as Y,a9 as Q,B as X,F as Z,E as z,j as e,G as k,H as M,I as L,S as ee,K as T,L as B,M as U,a4 as A,C as q}from"./index-a996d77c.js";import{S as $}from"./scroll-area-e284f479.js";import{S as te}from"./search-9e1431e9.js";import{P as K}from"./plus-6598b712.js";import{P as se}from"./package-ac08302c.js";import{S as F}from"./shopping-cart-1da4abb8.js";import{T as ae}from"./trash-2-99337be2.js";const ne=V("Ban",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m4.9 4.9 14.2 14.2",key:"1m5liu"}]]),re=V("Minus",[["path",{d:"M5 12h14",key:"1ays0h"}]]);function D(){const s=t.useRef(!1);return O(()=>(s.current=!0,()=>{s.current=!1}),[]),s}function oe(){const s=D(),[c,n]=t.useState(0),a=t.useCallback(()=>{s.current&&n(c+1)},[c]);return[t.useCallback(()=>W.postRender(a),[a]),c]}class ie extends t.Component{getSnapshotBeforeUpdate(c){const n=this.props.childRef.current;if(n&&c.isPresent&&!this.props.isPresent){const a=this.props.sizeRef.current;a.height=n.offsetHeight||0,a.width=n.offsetWidth||0,a.top=n.offsetTop,a.left=n.offsetLeft}return null}componentDidUpdate(){}render(){return this.props.children}}function ce({children:s,isPresent:c}){const n=t.useId(),a=t.useRef(null),C=t.useRef({width:0,height:0,top:0,left:0});return t.useInsertionEffect(()=>{const{width:d,height:h,top:p,left:v}=C.current;if(c||!a.current||!d||!h)return;a.current.dataset.motionPopId=n;const g=document.createElement("style");return document.head.appendChild(g),g.sheet&&g.sheet.insertRule(`
          [data-motion-pop-id="${n}"] {
            position: absolute !important;
            width: ${d}px !important;
            height: ${h}px !important;
            top: ${p}px !important;
            left: ${v}px !important;
          }
        `),()=>{document.head.removeChild(g)}},[c]),t.createElement(ie,{isPresent:c,childRef:a,sizeRef:C},t.cloneElement(s,{ref:a}))}const I=({children:s,initial:c,isPresent:n,onExitComplete:a,custom:C,presenceAffectsLayout:d,mode:h})=>{const p=J(le),v=t.useId(),g=t.useMemo(()=>({id:v,initial:c,isPresent:n,custom:C,onExitComplete:u=>{p.set(u,!0);for(const o of p.values())if(!o)return;a&&a()},register:u=>(p.set(u,!1),()=>p.delete(u))}),d?void 0:[n]);return t.useMemo(()=>{p.forEach((u,o)=>p.set(o,!1))},[n]),t.useEffect(()=>{!n&&!p.size&&a&&a()},[n]),h==="popLayout"&&(s=t.createElement(ce,{isPresent:n},s)),t.createElement(Y.Provider,{value:g},s)};function le(){return new Map}function de(s){return t.useEffect(()=>()=>s(),[])}const E=s=>s.key||"";function ue(s,c){s.forEach(n=>{const a=E(n);c.set(a,n)})}function fe(s){const c=[];return t.Children.forEach(s,n=>{t.isValidElement(n)&&c.push(n)}),c}const me=({children:s,custom:c,initial:n=!0,onExitComplete:a,exitBeforeEnter:C,presenceAffectsLayout:d=!0,mode:h="sync"})=>{const p=t.useContext(Q).forceRender||oe()[0],v=D(),g=fe(s);let u=g;const o=t.useRef(new Map).current,l=t.useRef(u),w=t.useRef(new Map).current,R=t.useRef(!0);if(O(()=>{R.current=!1,ue(g,w),l.current=u}),de(()=>{R.current=!0,w.clear(),o.clear()}),R.current)return t.createElement(t.Fragment,null,u.map(f=>t.createElement(I,{key:E(f),isPresent:!0,initial:n?void 0:!1,presenceAffectsLayout:d,mode:h},f)));u=[...u];const S=l.current.map(E),P=g.map(E),b=S.length;for(let f=0;f<b;f++){const y=S[f];P.indexOf(y)===-1&&!o.has(y)&&o.set(y,void 0)}return h==="wait"&&o.size&&(u=[]),o.forEach((f,y)=>{if(P.indexOf(y)!==-1)return;const _=w.get(y);if(!_)return;const r=S.indexOf(y);let i=f;if(!i){const j=()=>{o.delete(y);const m=Array.from(w.keys()).filter(N=>!P.includes(N));if(m.forEach(N=>w.delete(N)),l.current=g.filter(N=>{const x=E(N);return x===y||m.includes(x)}),!o.size){if(v.current===!1)return;p(),a&&a()}};i=t.createElement(I,{key:E(_),isPresent:!1,onExitComplete:j,custom:c,presenceAffectsLayout:d,mode:h},_),o.set(y,i)}u.splice(r,0,i)}),u=u.map(f=>{const y=f.key;return o.has(y)?f:t.createElement(I,{key:E(f),isPresent:!0,presenceAffectsLayout:d,mode:h},f)}),t.createElement(t.Fragment,null,o.size?u:u.map(f=>t.cloneElement(f)))},he=()=>{const{toast:s}=X(),[c,n]=t.useState([]),[a,C]=t.useState(""),[d,h]=t.useState([]),[p,v]=t.useState(!0),[g,u]=t.useState(!1),[o,l]=t.useState(null);t.useEffect(()=>{const r=localStorage.getItem(Z);if(r){const i=JSON.parse(r);l(i)}},[]);const w=t.useCallback(async()=>{if(o){v(!0);try{const{data:r,error:i}=await z.from("inventario_fisico").select("id, codigo, nome, quantidade, unidade, custo_medio_unitario").eq("user_id",o.id).eq("cnpj_loja",o.cnpj).gt("quantidade",0);if(i)throw i;const j=r.map(m=>({...m,valor_venda:m.custo_medio_unitario?m.custo_medio_unitario*1.3:0}));n(j)}catch(r){s({title:"Erro ao buscar produtos",description:r.message,variant:"destructive"})}finally{v(!1)}}},[o,s]);t.useEffect(()=>{o&&w()},[o,w]);const R=t.useMemo(()=>c.filter(r=>r.nome.toLowerCase().includes(a.toLowerCase())||r.codigo.toLowerCase().includes(a.toLowerCase())),[c,a]),S=t.useMemo(()=>d.reduce((r,i)=>r+i.valor_venda*i.quantity,0),[d]),P=r=>{h(i=>{const j=i.find(m=>m.id===r.id);return j?j.quantity<r.quantidade?i.map(m=>m.id===r.id?{...m,quantity:m.quantity+1}:m):(s({title:"Estoque máximo atingido",variant:"default"}),i):[...i,{...r,quantity:1}]})},b=(r,i)=>{const j=c.find(m=>m.id===r);if(i<=0){f(r);return}if(j&&i>j.quantidade){s({title:`Estoque máximo para este item é ${j.quantidade}`,variant:"default"});return}h(m=>m.map(N=>N.id===r?{...N,quantity:i}:N))},f=r=>{h(i=>i.filter(j=>j.id!==r))};return{searchTerm:a,setSearchTerm:C,filteredProducts:R,cart:d,loading:p,isProcessing:g,handleAddToCart:P,handleUpdateQuantity:b,handleRemoveFromCart:f,handleCancelSale:()=>{h([]),s({title:"Venda cancelada"})},handleFinalizeSale:async()=>{if(!(d.length===0||!o)){u(!0);try{const r={numero_cupom:`CUPOM-${Date.now()}`,status:"finalizada",dados:{items:d.map(x=>({id:x.id,codigo:x.codigo,nome:x.nome,quantity:x.quantity,valor_venda:x.valor_venda,total_item:x.valor_venda*x.quantity})),total:S},loja_id:o.cnpj,usuario_id:o.id},{error:i}=await z.from("notas_fiscais_saida").insert([r]);if(i)throw i;const j=d.map(x=>{const H=c.find(G=>G.id===x.id);return z.from("inventario_fisico").update({quantidade:H.quantidade-x.quantity}).eq("id",x.id)});if((await Promise.all(j)).filter(x=>x.error).length>0)throw new Error("Erro ao atualizar o estoque de um ou mais itens.");s({title:"Venda finalizada com sucesso!",description:`Cupom ${r.numero_cupom} gerado.`}),h([]),w()}catch(r){s({title:"Erro ao finalizar a venda",description:r.message,variant:"destructive"})}finally{u(!1)}}},cartTotal:S}},Ne=()=>{const{searchTerm:s,setSearchTerm:c,filteredProducts:n,cart:a,loading:C,isProcessing:d,handleAddToCart:h,handleUpdateQuantity:p,handleRemoveFromCart:v,handleCancelSale:g,handleFinalizeSale:u,cartTotal:o}=he();return e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-10rem)]",children:[e.jsxs(k,{className:"lg:col-span-2 flex flex-col glass-card",children:[e.jsxs(M,{children:[e.jsxs(L,{className:"flex items-center gap-2",children:[e.jsx(te,{className:"h-6 w-6"}),"Selecione os Produtos"]}),e.jsx(ee,{placeholder:"Buscar por nome ou código...",value:s,onChange:l=>c(l.target.value),className:"mt-2"})]}),e.jsx(T,{className:"flex-1 overflow-hidden",children:C?e.jsxs("div",{className:"flex items-center justify-center h-full",children:[e.jsx(B,{size:48}),e.jsx("p",{className:"ml-3",children:"Carregando produtos..."})]}):e.jsx($,{className:"h-full pr-4",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4",children:[e.jsx(me,{children:n.map(l=>e.jsx(U.div,{layout:!0,initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.9},transition:{duration:.2},children:e.jsxs(k,{className:"hover:shadow-lg transition-shadow h-full flex flex-col",children:[e.jsx(M,{className:"p-4 flex-grow",children:e.jsx(L,{className:"text-base",children:l.nome})}),e.jsxs(T,{className:"p-4 pt-0",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Código: ",l.codigo]}),e.jsxs("p",{className:"text-sm text-primary font-semibold",children:["Estoque: ",l.quantidade," ",l.unidade]})]}),e.jsx(A,{className:"p-4 pt-0",children:e.jsxs(q,{className:"w-full",onClick:()=>h(l),disabled:l.quantidade<=0,children:[e.jsx(K,{className:"mr-2 h-4 w-4"})," Adicionar"]})})]})},l.id))}),!C&&n.length===0&&e.jsxs("div",{className:"col-span-full text-center py-10",children:[e.jsx(se,{className:"mx-auto h-12 w-12 text-muted-foreground"}),e.jsx("p",{className:"mt-4 text-muted-foreground",children:"Nenhum produto encontrado"})]})]})})})]}),e.jsxs(k,{className:"lg:col-span-1 flex flex-col glass-card",children:[e.jsx(M,{children:e.jsxs(L,{className:"flex items-center gap-2",children:[e.jsx(F,{className:"h-6 w-6"}),"Cupom de Venda"]})}),e.jsx(T,{className:"flex-1 overflow-hidden",children:e.jsx($,{className:"h-full pr-4",children:a.length===0?e.jsx("div",{className:"flex items-center justify-center h-full text-center text-muted-foreground",children:e.jsxs("div",{children:[e.jsx(F,{className:"mx-auto h-12 w-12"}),e.jsx("p",{className:"mt-4",children:"Seu carrinho está vazio."})]})}):e.jsx("div",{className:"space-y-3",children:a.map(l=>e.jsxs(U.div,{className:"flex items-center gap-3 bg-muted/50 p-3 rounded-lg",layout:!0,initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,x:-20},children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold",children:l.nome}),e.jsx("p",{className:"text-sm text-muted-foreground",children:l.valor_venda.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{variant:"outline",size:"icon",className:"h-7 w-7",onClick:()=>p(l.id,l.quantity-1),disabled:d,children:e.jsx(re,{className:"h-4 w-4"})}),e.jsx("span",{className:"w-6 text-center",children:l.quantity}),e.jsx(q,{variant:"outline",size:"icon",className:"h-7 w-7",onClick:()=>p(l.id,l.quantity+1),disabled:d,children:e.jsx(K,{className:"h-4 w-4"})})]}),e.jsx(q,{variant:"ghost",size:"icon",className:"h-7 w-7 text-destructive",onClick:()=>v(l.id),disabled:d,children:e.jsx(ae,{className:"h-4 w-4"})})]},l.id))})})}),e.jsxs(A,{className:"flex-col gap-4 !p-6 border-t mt-auto",children:[e.jsxs("div",{className:"flex justify-between w-full text-xl font-bold",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{children:o.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 w-full",children:[e.jsxs(q,{variant:"destructive",onClick:g,disabled:d||a.length===0,children:[e.jsx(ne,{className:"mr-2 h-4 w-4"})," Cancelar"]}),e.jsxs(q,{className:"bg-green-600 hover:bg-green-700 text-white",onClick:u,disabled:d||a.length===0,children:[d?e.jsx(B,{className:"mr-2"}):e.jsx(F,{className:"mr-2 h-4 w-4"}),"Finalizar Venda"]})]})]})]})]})};export{Ne as default};
