import{c as T,B as G,r as b,j as e,G as L,H as O,I as z,K as R,S as y,C as S,L as U,U as F,E as P,A as je,M as fe,F as _e}from"./index-a996d77c.js";import{u as $,w as ee,r as be}from"./xlsx-81fdaaba.js";import{S as re,a as te,b as oe,c as ne,d as ie}from"./select-c1f59cc1.js";import{g as Ne}from"./partesAnimais-e74d50b3.js";import{P as ye}from"./plus-circle-b044468d.js";import{S as Y}from"./save-d76e1658.js";import{D as Se}from"./download-e041ef9d.js";import{F as qe}from"./file-spreadsheet-53adb39f.js";import{p as ae}from"./partesBoi-e27c0c05.js";import{T as Ce}from"./trash-2-99337be2.js";import{C as we}from"./calculator-05e64e1e.js";import{A as Ie}from"./alert-triangle-3be795c1.js";import{T as le}from"./trending-up-62c7af95.js";import{T as ke}from"./trending-down-500a800d.js";import{P as Fe}from"./package-ac08302c.js";import{D as Ae}from"./dollar-sign-0ce09540.js";import{D as de,a as ce,b as ue,c as me,d as he,e as pe}from"./dialog-143d4e79.js";import{S as Ee}from"./scroll-area-e284f479.js";import"./component-78adbb4d.js";import"./check-81dc6077.js";import"./Combination-a26b2933.js";const Pe=T("CheckCircle2",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]),Qe=T("FolderArchive",[["circle",{cx:"15",cy:"19",r:"2",key:"u2pros"}],["path",{d:"M20.9 19.8A2 2 0 0 0 22 18V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2h5.1",key:"1jj40k"}],["path",{d:"M15 11v-1",key:"cntcp"}],["path",{d:"M15 17v-2",key:"1279jj"}]]),Me=T("FolderOpen",[["path",{d:"m6 14 1.5-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.54 6a2 2 0 0 1-1.95 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H18a2 2 0 0 1 2 2v2",key:"usdka0"}]]),De=T("PackageOpen",[["path",{d:"M20.91 8.84 8.56 2.23a1.93 1.93 0 0 0-1.81 0L3.1 4.13a2.12 2.12 0 0 0-.05 3.69l12.22 6.93a2 2 0 0 0 1.94 0L21 12.51a2.12 2.12 0 0 0-.09-3.67Z",key:"1vy178"}],["path",{d:"m3.09 8.84 12.35-6.61a1.93 1.93 0 0 1 1.81 0l3.65 1.9a2.12 2.12 0 0 1 .1 3.69L8.73 14.75a2 2 0 0 1-1.94 0L3 12.51a2.12 2.12 0 0 1 .09-3.67Z",key:"s3bv25"}],["line",{x1:"12",x2:"12",y1:"22",y2:"13",key:"1o4xyi"}],["path",{d:"M20 13.5v3.37a2.06 2.06 0 0 1-1.11 1.83l-6 3.08a1.93 1.93 0 0 1-1.78 0l-6-3.08A2.06 2.06 0 0 1 4 16.87V13.5",key:"1na2nq"}]]),$e=T("PenLine",[["path",{d:"M12 20h9",key:"t2du7b"}],["path",{d:"M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z",key:"ymcmye"}]]),Le=T("XCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]]),Oe=({currentUser:a,setItensInventario:c,onFileUploadUnificado:l,onSaveInventario:u,onOpenSearchModal:p,itensInventario:s})=>{const{toast:d}=G(),[i,o]=b.useState({codigo:"",nome:"",quantidade:"",unidade:"kg",parte_boi:""}),[m,f]=b.useState(!1),h=Ne("bovino"),_=async()=>{if(!i.codigo||!i.nome||!i.quantidade){d({title:"Erro",description:"Preencha todos os campos do item.",variant:"destructive"});return}if(!a||!a.id||!a.cnpj){d({title:"Erro",description:"Usuário ou CNPJ não identificado para salvar.",variant:"destructive"});return}f(!0);try{const x={...i,user_id:a.id,cnpj_loja:a.cnpj,quantidade:parseFloat(i.quantidade)},{data:A,error:N}=await P.from("inventario_fisico").insert([x]).select();if(N)throw N;if(A&&A.length>0){const Q={...A[0],estoque_inicial:"",compras:"",outras_entradas:"",vendas:"",outras_saidas:"",estoque_fisico_contado:"",custo_medio_unitario:"",estoque_calculado:0,divergencia:0,divergencia_valor:0,percentual_quebra:0,mensagem_quebra:"",cor_mensagem:"text-muted-foreground"};c(g=>[Q,...g]),o({codigo:"",nome:"",quantidade:"",unidade:"kg",parte_boi:""}),d({title:"Sucesso",description:"Item adicionado ao inventário."})}}catch(x){d({title:"Erro ao Adicionar Item",description:x.message,variant:"destructive"})}finally{f(!1)}},I=()=>{const x=[["codigo_produto","nome_produto","quantidade_estoque","unidade","parte_boi","estoque_inicial","compras","outras_entradas","vendas","outras_saidas","estoque_fisico_contado","custo_medio_unitario"],["P001","Picanha","10.5","kg","traseiro","100","50","10","80","5","72","55.90"],["A002","Alcatra","5","un","traseiro","50","20","0","40","2","28","42.50"]],A=$.aoa_to_sheet(x),N=$.book_new();$.book_append_sheet(N,A,"ModeloUnificadoInventario"),ee(N,`Modelo_Unificado_Inventario_${je}.xlsx`),d({title:"Download Iniciado",description:"Modelo de planilha unificada baixado."})},t=()=>{if(!s||s.length===0){d({title:"Erro",description:"Nenhum item para exportar.",variant:"destructive"});return}try{const x=s.map(g=>({Código:g.codigo||"","Nome do Item":g.nome||"","Quantidade Atual":g.quantidade||0,Unidade:g.unidade||"","Parte do Boi":g.parte_boi||"","Estoque Inicial":g.estoque_inicial||0,Compras:g.compras||0,"Outras Entradas":g.outras_entradas||0,Vendas:g.vendas||0,"Outras Saídas":g.outras_saidas||0,"Estoque Físico Contado":g.estoque_fisico_contado||0,"Custo Médio Unitário (R$)":g.custo_medio_unitario||0,"Estoque Calculado":g.estoque_calculado||0,"Divergência (Qtd)":g.divergencia||0,"Divergência (R$)":g.divergencia_valor||0,"Percentual Quebra/Sobra (%)":g.percentual_quebra||0,Análise:g.mensagem_quebra||""})),A=$.json_to_sheet(x),N=$.book_new();$.book_append_sheet(N,A,"Análise de Quebras");const Q=`Analise_Quebras_Inventario_${new Date().toLocaleDateString("pt-BR").replace(/\//g,"-")}.xlsx`;ee(N,Q),d({title:"Exportação Concluída",description:`Arquivo "${Q}" baixado com sucesso!`})}catch{d({title:"Erro na Exportação",description:"Não foi possível exportar os dados. Tente novamente.",variant:"destructive"})}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs(L,{className:"glass-card",children:[e.jsx(O,{children:e.jsx(z,{children:"Adicionar Novo Item Manualmente"})}),e.jsxs(R,{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-4 items-end",children:[e.jsx(y,{placeholder:"Código",value:i.codigo,onChange:x=>o({...i,codigo:x.target.value}),disabled:m}),e.jsx(y,{placeholder:"Nome",value:i.nome,onChange:x=>o({...i,nome:x.target.value}),disabled:m}),e.jsx(y,{type:"number",placeholder:"Quantidade",value:i.quantidade,onChange:x=>o({...i,quantidade:x.target.value}),disabled:m}),e.jsxs(re,{value:i.parte_boi,onValueChange:x=>o({...i,parte_boi:x}),children:[e.jsx(te,{children:e.jsx(oe,{placeholder:"Parte do Boi"})}),e.jsx(ne,{children:h.map(x=>e.jsx(ie,{value:x.value,children:x.label},x.value))})]}),e.jsxs(S,{onClick:_,disabled:m,className:"w-full",children:[m?e.jsx(U,{className:"mr-2"}):e.jsx(ye,{className:"mr-2 h-4 w-4"})," Adicionar"]})]})]}),e.jsxs(L,{className:"glass-card",children:[e.jsx(O,{children:e.jsx(z,{children:"Ações do Inventário"})}),e.jsxs(R,{className:"flex flex-col sm:flex-row gap-3",children:[e.jsxs(S,{onClick:p,className:"w-full flex-1",children:[e.jsx(Me,{className:"mr-2 h-4 w-4"})," Carregar Inventário Salvo"]}),e.jsxs(S,{onClick:u,className:"w-full flex-1 bg-green-600 hover:bg-green-700 text-white",children:[e.jsx(Y,{className:"mr-2 h-4 w-4"})," Salvar Inventário Atual"]})]})]})]}),e.jsxs(L,{className:"glass-card",children:[e.jsx(O,{children:e.jsx(z,{children:"Importar Dados do Inventário"})}),e.jsxs(R,{className:"grid grid-cols-1 sm:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-semibold",children:"Planilha Unificada"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Use esta planilha para criar novos itens e/ou atualizar dados de análise de uma só vez."}),e.jsxs(S,{onClick:I,variant:"outline",className:"w-full",children:[e.jsx(Se,{className:"mr-2 h-4 w-4"})," Baixar Modelo Unificado"]}),e.jsxs("div",{children:[e.jsx(F,{htmlFor:"uploadPlanilhaUnificada",className:"text-sm font-medium",children:"Carregar Planilha Unificada"}),e.jsx(y,{id:"uploadPlanilhaUnificada",type:"file",accept:".xlsx, .xls",onChange:l,className:"text-xs"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-semibold",children:"Exportar Análises Atuais"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Exporte os dados de análise de quebras que estão atualmente na tela para uma planilha Excel."}),e.jsxs(S,{onClick:t,variant:"outline",className:"w-full bg-emerald-600 hover:bg-emerald-700 text-white",children:[e.jsx(qe,{className:"mr-2 h-4 w-4"})," Exportar Análises"]})]})]})]})]})},ze=({item:a,editingItemId:c,editedItemData:l,isSavingEdit:u,onEditItem:p,onSaveEdit:s,onCancelEdit:d,onInputChange:i,onDeleteItem:o,onUpdateItemAnalise:m,onCalcularAnaliseQuebraItem:f,onSaveItemAnalise:h})=>{var I;const _=c===a.id;return e.jsxs(fe.div,{className:"border rounded-lg p-4 bg-background/50 shadow-sm hover:shadow-md transition-shadow duration-300 relative",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.3},children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-3",children:_?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(F,{htmlFor:`edit-codigo-${a.id}`,children:"Código"}),e.jsx(y,{id:`edit-codigo-${a.id}`,value:l.codigo,onChange:t=>i("codigo",t.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(F,{htmlFor:`edit-nome-${a.id}`,children:"Nome"}),e.jsx(y,{id:`edit-nome-${a.id}`,value:l.nome,onChange:t=>i("nome",t.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs(F,{htmlFor:`edit-quantidade-${a.id}`,children:["Quantidade (",l.unidade,")"]}),e.jsx(y,{id:`edit-quantidade-${a.id}`,type:"number",value:l.quantidade,onChange:t=>i("quantidade",t.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(F,{children:"Parte do Boi"}),e.jsxs(re,{value:l.parte_boi,onValueChange:t=>i("parte_boi",t),children:[e.jsx(te,{children:e.jsx(oe,{placeholder:"Selecione"})}),e.jsx(ne,{children:ae.map(t=>e.jsx(ie,{value:t.value,children:t.label},t.value))})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"font-medium",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Código"}),a.codigo]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Nome"}),a.nome]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Estoque Atual"}),a.quantidade," ",e.jsx("span",{className:"text-xs",children:a.unidade})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Parte do Boi"}),((I=ae.find(t=>t.value===a.parte_boi))==null?void 0:I.label)||"N/A"]})]})}),_&&e.jsxs("div",{className:"flex gap-2 mb-4",children:[e.jsxs(S,{onClick:()=>s(a.id),size:"sm",disabled:u,children:[u?e.jsx(U,{size:16}):e.jsx(Y,{className:"mr-1 h-4 w-4"})," Salvar"]}),e.jsxs(S,{onClick:d,size:"sm",variant:"outline",children:[e.jsx(Le,{className:"mr-1 h-4 w-4"})," Cancelar"]})]}),!_&&e.jsx(S,{onClick:()=>p(a),size:"sm",variant:"ghost",className:"absolute top-2 right-12 text-muted-foreground hover:text-primary p-1",children:e.jsx($e,{className:"h-4 w-4"})}),e.jsx(S,{onClick:()=>o(a.id),size:"sm",variant:"ghost",className:"absolute top-2 right-2 text-muted-foreground hover:text-destructive p-1",children:e.jsx(Ce,{className:"h-4 w-4"})}),e.jsxs(L,{className:"mt-2 bg-muted/30",children:[e.jsx(O,{className:"py-3 px-4",children:e.jsxs(z,{className:"text-base flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center",children:[e.jsx(De,{className:"mr-2 h-5 w-5 text-sky-600"}),"Análise de Quebra do Item"]}),h&&e.jsxs(S,{onClick:()=>h(a.id),size:"sm",className:"bg-green-600 hover:bg-green-700 text-white",children:[e.jsx(Y,{className:"mr-1 h-3 w-3"})," Salvar Análise"]})]})}),e.jsxs(R,{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3",children:[e.jsxs("div",{children:[e.jsx(F,{children:"Est. Inicial"}),e.jsx(y,{type:"number",placeholder:"Qtd",value:a.estoque_inicial||"",onChange:t=>m(a.id,"estoque_inicial",t.target.value)})]}),e.jsxs("div",{children:[e.jsx(F,{children:"Compras"}),e.jsx(y,{type:"number",placeholder:"Qtd",value:a.compras||"",onChange:t=>m(a.id,"compras",t.target.value)})]}),e.jsxs("div",{children:[e.jsx(F,{children:"Outras Ent."}),e.jsx(y,{type:"number",placeholder:"Qtd",value:a.outras_entradas||"",onChange:t=>m(a.id,"outras_entradas",t.target.value)})]}),e.jsxs("div",{children:[e.jsx(F,{children:"Vendas"}),e.jsx(y,{type:"number",placeholder:"Qtd",value:a.vendas||"",onChange:t=>m(a.id,"vendas",t.target.value)})]}),e.jsxs("div",{children:[e.jsx(F,{children:"Outras Saídas"}),e.jsx(y,{type:"number",placeholder:"Qtd",value:a.outras_saidas||"",onChange:t=>m(a.id,"outras_saidas",t.target.value)})]}),e.jsxs("div",{children:[e.jsx(F,{children:"Est. Físico"}),e.jsx(y,{type:"number",placeholder:"Qtd",value:a.estoque_fisico_contado||"",onChange:t=>m(a.id,"estoque_fisico_contado",t.target.value)})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(F,{children:"Custo Médio Unit. (R$)"}),e.jsx(y,{type:"number",placeholder:"0.00",value:a.custo_medio_unitario||"",onChange:t=>m(a.id,"custo_medio_unitario",t.target.value)})]})]}),e.jsxs(S,{onClick:()=>f(a.id),size:"sm",className:"w-full md:w-auto bg-sky-600 hover:bg-sky-700",children:[e.jsx(we,{className:"mr-2 h-4 w-4"})," Calcular Quebra do Item"]}),(a.estoque_calculado!==0||a.divergencia!==0)&&e.jsxs("div",{className:"mt-3 pt-3 border-t",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-2 text-xs text-center",children:[e.jsxs("div",{className:"p-2 bg-background/40 rounded",children:["Est. Calculado: ",e.jsx("span",{className:"font-bold",children:a.estoque_calculado})]}),e.jsxs("div",{className:`p-2 rounded ${parseFloat(a.divergencia)>=0?"bg-green-500/10 text-green-700":"bg-red-500/10 text-red-700"}`,children:["Divergência (Qtd): ",e.jsx("span",{className:"font-bold",children:a.divergencia})]}),e.jsxs("div",{className:`p-2 rounded ${parseFloat(a.divergencia_valor)>=0?"bg-green-500/10 text-green-700":"bg-red-500/10 text-red-700"}`,children:["Divergência (R$): ",e.jsx("span",{className:"font-bold",children:parseFloat(a.divergencia_valor).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),e.jsxs("div",{className:`p-2 rounded ${Math.abs(parseFloat(a.percentual_quebra))<=2&&parseFloat(a.percentual_quebra)>=0?"bg-green-500/10 text-green-700":parseFloat(a.percentual_quebra)<0?"bg-blue-500/10 text-blue-700":"bg-red-500/10 text-red-700"}`,children:["% Quebra/Sobra: ",e.jsxs("span",{className:"font-bold",children:[a.percentual_quebra,"%"]})]})]}),a.mensagem_quebra&&e.jsxs("p",{className:`mt-2 text-center text-xs font-medium flex items-center justify-center p-2 rounded ${a.cor_mensagem.includes("red")?"bg-red-500/10":a.cor_mensagem.includes("green")?"bg-green-500/10":"bg-blue-500/10"}`,children:[a.cor_mensagem.includes("red")&&e.jsx(Ie,{className:`mr-1 h-4 w-4 ${a.cor_mensagem}`}),a.cor_mensagem.includes("green")&&e.jsx(Pe,{className:`mr-1 h-4 w-4 ${a.cor_mensagem}`}),a.cor_mensagem.includes("blue")&&e.jsx(le,{className:`mr-1 h-4 w-4 ${a.cor_mensagem}`}),e.jsx("span",{className:a.cor_mensagem,children:a.mensagem_quebra})]})]})]})]})]})},Re=({itensInventario:a,setItensInventario:c,loading:l,currentUser:u,fetchInventario:p,handleUpdateItemAnalise:s,calcularAnaliseQuebraItem:d,handleSaveItemAnalise:i})=>{const{toast:o}=G(),[m,f]=b.useState(null),[h,_]=b.useState({}),[I,t]=b.useState(!1),x=async j=>{if(!(!j||!u||!u.id)&&window.confirm("Tem certeza que deseja excluir este item?"))try{const{error:q}=await P.from("inventario_fisico").delete().match({id:j,user_id:u.id});if(q)throw q;c(M=>M.filter(B=>B.id!==j)),o({title:"Sucesso",description:"Item removido do inventário."})}catch(q){o({title:"Erro ao Remover Item",description:q.message,variant:"destructive"})}},A=j=>{f(j.id),_({codigo:j.codigo,nome:j.nome,quantidade:String(j.quantidade),unidade:j.unidade,parte_boi:j.parte_boi||""})},N=async j=>{if(!u||!u.id){o({title:"Erro de Autenticação",variant:"destructive"});return}t(!0);try{const{data:q,error:M}=await P.from("inventario_fisico").update({codigo:h.codigo,nome:h.nome,quantidade:parseFloat(h.quantidade),unidade:h.unidade,parte_boi:h.parte_boi}).eq("id",j).eq("user_id",u.id).select();if(M)throw M;q&&q.length>0&&(c(B=>B.map(V=>V.id===j?{...V,...q[0]}:V)),o({title:"Sucesso",description:"Item atualizado."})),f(null)}catch(q){o({title:"Erro ao Atualizar",description:q.message,variant:"destructive"})}finally{t(!1)}},Q=()=>{f(null),_({})},g=(j,q)=>{_(M=>({...M,[j]:q}))};return e.jsxs(L,{className:"glass-card",children:[e.jsx(O,{children:e.jsx(z,{children:"Itens no Inventário e Análise de Quebras"})}),e.jsxs(R,{children:[a.length===0&&!l?e.jsx("p",{className:"text-muted-foreground text-center py-4",children:"Nenhum item no inventário. Adicione itens manualmente ou importe uma planilha."}):e.jsx("div",{className:"space-y-4",children:a.map(j=>e.jsx(ze,{item:j,editingItemId:m,editedItemData:h,isSavingEdit:I,onEditItem:A,onSaveEdit:N,onCancelEdit:Q,onInputChange:g,onDeleteItem:x,onUpdateItemAnalise:s,onCalcularAnaliseQuebraItem:d,onSaveItemAnalise:i},j.id))}),l&&e.jsxs("div",{className:"text-center py-4",children:[e.jsx(U,{})," Carregando itens..."]})]})]})},Te=({itensInventario:a})=>{let c=0,l=0,u=0,p=0;a.forEach(o=>{const m=parseFloat(o.divergencia)||0,f=parseFloat(o.divergencia_valor)||0;m<0?(c+=Math.abs(m),l+=Math.abs(f)):m>0&&(u+=m,p+=f)});const s=u-c,d=p-l,i=({title:o,quantidade:m,valor:f,icon:h,colorClass:_})=>e.jsxs(L,{className:`glass-card border-l-4 ${_}`,children:[e.jsx(O,{className:"pb-2",children:e.jsxs(z,{className:"text-lg flex items-center",children:[h,e.jsx("span",{className:"ml-2",children:o})]})}),e.jsxs(R,{children:[e.jsx("p",{className:"text-2xl font-bold",children:m.toLocaleString("pt-BR")}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Quantidade"}),e.jsx("p",{className:"text-2xl font-bold mt-2",children:f.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Valor Financeiro"})]})]});return e.jsxs("div",{className:"my-6",children:[e.jsx("h2",{className:"text-2xl font-semibold mb-4 text-center text-gradient-secondary",children:"Resumo Financeiro das Quebras e Sobras"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx(i,{title:"Total de Quebras",quantidade:c,valor:l,icon:e.jsx(ke,{className:"h-6 w-6 text-red-500"}),colorClass:"border-red-500"}),e.jsx(i,{title:"Total de Sobras",quantidade:u,valor:p,icon:e.jsx(le,{className:"h-6 w-6 text-green-500"}),colorClass:"border-green-500"}),e.jsx(i,{title:"Saldo Geral (Qtd)",quantidade:s,valor:0,icon:e.jsx(Fe,{className:`h-6 w-6 ${s>=0?"text-green-500":"text-red-500"}`}),colorClass:s>=0?"border-green-500":"border-red-500"}),e.jsx(i,{title:"Saldo Geral (R$)",quantidade:0,valor:d,icon:e.jsx(Ae,{className:`h-6 w-6 ${d>=0?"text-green-500":"text-red-500"}`}),colorClass:d>=0?"border-green-500":"border-red-500"})]})]})},Be=({open:a,setOpen:c,onConfirmSave:l})=>{const[u,p]=b.useState(""),{toast:s}=G(),d=()=>{if(!u.trim()){s({title:"Nome Obrigatório",description:"Por favor, dê um nome ao seu inventário.",variant:"destructive"});return}l(u),p("")};return e.jsx(de,{open:a,onOpenChange:c,children:e.jsxs(ce,{className:"sm:max-w-[425px] glass-card",children:[e.jsxs(ue,{children:[e.jsx(me,{children:"Salvar Inventário Atual"}),e.jsx(he,{children:'Dê um nome para este "retrato" do seu inventário. Isso permitirá que você o consulte mais tarde.'})]}),e.jsx("div",{className:"grid gap-4 py-4",children:e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(F,{htmlFor:"name",className:"text-right",children:"Nome"}),e.jsx(y,{id:"name",value:u,onChange:i=>p(i.target.value),className:"col-span-3",placeholder:`Inventário ${new Date().toLocaleDateString("pt-BR")}`})]})}),e.jsxs(pe,{children:[e.jsx(S,{variant:"outline",onClick:()=>c(!1),children:"Cancelar"}),e.jsx(S,{type:"submit",onClick:d,children:"Confirmar e Salvar"})]})]})})},Ve=({open:a,setOpen:c,inventarios:l,isLoading:u,onSelectInventario:p})=>e.jsx(de,{open:a,onOpenChange:c,children:e.jsxs(ce,{className:"sm:max-w-md glass-card",children:[e.jsxs(ue,{children:[e.jsx(me,{children:"Carregar Inventário Salvo"}),e.jsx(he,{children:"Selecione um dos inventários salvos para visualizar seus dados."})]}),e.jsx(Ee,{className:"h-72 w-full rounded-md border p-4",children:u?e.jsxs("div",{className:"flex items-center justify-center h-full",children:[e.jsx(U,{}),e.jsx("p",{className:"ml-2",children:"Buscando inventários..."})]}):l.length>0?e.jsx("div",{className:"space-y-2",children:l.map((s,d)=>e.jsxs(S,{variant:"ghost",className:"w-full justify-start",onClick:()=>p(s),children:[e.jsx(Qe,{className:"mr-2 h-4 w-4"}),s]},d))}):e.jsx("div",{className:"flex items-center justify-center h-full text-muted-foreground",children:"Nenhum inventário salvo encontrado."})}),e.jsx(pe,{children:e.jsx(S,{variant:"outline",onClick:()=>c(!1),children:"Fechar"})})]})}),se=a=>{const c=parseFloat(a.estoque_inicial)||0,l=parseFloat(a.compras)||0,u=parseFloat(a.outras_entradas)||0,p=parseFloat(a.vendas)||0,s=parseFloat(a.outras_saidas)||0,d=parseFloat(a.estoque_fisico_contado)||0,i=parseFloat(a.custo_medio_unitario)||0,o=c+u+l-p-s,m=d-o,f=m*i;let h=0;o>0?h=(o-d)/o*100:d>0&&o<=0?h=-100:o===0&&d===0?h=0:o<0&&d>o&&(h=-100);let _="",I="text-muted-foreground";return h>2?(_=`Atenção! Quebra de ${h.toFixed(2)}% acima do aceitável.`,I="text-red-500"):h>=0&&h<=2?(_=`Parabéns! Quebra de ${h.toFixed(2)}% dentro do aceitável.`,I="text-green-500"):(_=`Sobra de ${Math.abs(h).toFixed(2)}% identificada.`,I="text-blue-500"),{estoque_calculado:o.toFixed(2),divergencia:m.toFixed(2),divergencia_valor:f.toFixed(2),percentual_quebra:h.toFixed(2),mensagem_quebra:_,cor_mensagem:I}},ma=()=>{const{toast:a}=G(),[c,l]=b.useState([]),[u,p]=b.useState(!0),[s,d]=b.useState(null),[i,o]=b.useState(!1),[m,f]=b.useState(!1),[h,_]=b.useState([]),[I,t]=b.useState(!1),[x,A]=b.useState("");b.useEffect(()=>{const n=localStorage.getItem(_e);n?d(JSON.parse(n)):(p(!1),a({title:"Erro de Autenticação",description:"Usuário não encontrado.",variant:"destructive"}))},[a]);const N=b.useCallback(async n=>{if(!(n!=null&&n.id)||!(n!=null&&n.cnpj)){p(!1);return}p(!0);try{const{data:v,error:r}=await P.from("inventario_fisico").select("*").eq("user_id",n.id).eq("cnpj_loja",n.cnpj).is("nome_inventario",null).order("created_at",{ascending:!1});if(r)throw r;const E=v.map(C=>({...C,estoque_inicial:"",compras:"",outras_entradas:"",vendas:"",outras_saidas:"",estoque_fisico_contado:"",custo_medio_unitario:"",estoque_calculado:0,divergencia:0,divergencia_valor:0,percentual_quebra:0,mensagem_quebra:"",cor_mensagem:"text-muted-foreground"}));l(E||[]),A("Inventário Atual (Não Salvo)")}catch(v){a({title:"Erro ao Carregar Inventário",description:v.message,variant:"destructive"})}finally{p(!1)}},[a]);b.useEffect(()=>{s&&N(s)},[s,N]);const Q=(n,v,r)=>{l(E=>E.map(C=>C.id===n?{...C,[v]:r}:C))},g=b.useCallback(n=>{l(v=>v.map(r=>{if(r.id===n){const E=se(r);return{...r,...E}}return r})),a({title:"Análise Calculada",description:"Quebra calculada para o item."})},[a]),j=async n=>{if(!s||!s.id){a({title:"Erro de Autenticação",variant:"destructive"});return}const v=c.find(r=>r.id===n);if(v)try{const{id:r,...E}=v,{error:C}=await P.from("inventario_fisico").update(E).eq("id",n).eq("user_id",s.id);if(C)throw C;a({title:"Análise Salva",description:"Os dados da análise de quebra foram salvos com sucesso!"})}catch(r){a({title:"Erro ao Salvar Análise",description:r.message,variant:"destructive"})}},q=n=>{const v=n.target.files[0];if(!v)return;const r=new FileReader;r.onload=async E=>{try{const C=new Uint8Array(E.target.result),Z=be(C,{type:"array"}),J=Z.SheetNames[0],xe=Z.Sheets[J],K=$.sheet_to_json(xe);if(K.length===0){a({title:"Erro",description:"Planilha vazia ou inválida.",variant:"destructive"});return}p(!0);const ge=new Set(c.map(w=>String(w.codigo).trim().toLowerCase())),X=K.filter(w=>{const H=String(w.codigo_produto||"").trim().toLowerCase();return H&&!ge.has(H)}).map(w=>({codigo:String(w.codigo_produto),nome:String(w.nome_produto||"Novo Item"),quantidade:parseFloat(w.quantidade_estoque||0),unidade:String(w.unidade||"kg"),parte_boi:String(w.parte_boi||""),user_id:s.id,cnpj_loja:s.cnpj}));if(X.length>0){const{error:w}=await P.from("inventario_fisico").insert(X);if(w)throw w;a({title:"Novos Itens Criados",description:`${X.length} novos itens foram adicionados ao inventário.`})}await N(s),l(w=>{const H=new Map(K.map(k=>[String(k.codigo_produto).trim().toLowerCase(),k]));return w.map(k=>{const D=H.get(String(k.codigo).trim().toLowerCase());if(D){const W={...k,estoque_inicial:String(D.estoque_inicial??k.estoque_inicial??""),compras:String(D.compras??k.compras??""),outras_entradas:String(D.outras_entradas??k.outras_entradas??""),vendas:String(D.vendas??k.vendas??""),outras_saidas:String(D.outras_saidas??k.outras_saidas??""),estoque_fisico_contado:String(D.estoque_fisico_contado??k.estoque_fisico_contado??""),custo_medio_unitario:String(D.custo_medio_unitario??k.custo_medio_unitario??"")},ve=se(W);return{...W,...ve}}return k})}),a({title:"Sucesso!",description:"Planilha processada. Itens atualizados e/ou criados."})}catch(C){console.error("Erro ao processar planilha:",C),a({title:"Erro ao Processar Planilha",description:C.message,variant:"destructive"})}finally{p(!1),n.target.value=null}},r.readAsArrayBuffer(v)},M=async n=>{if(!s||!s.id){a({title:"Erro de Autenticação",variant:"destructive"});return}if(c.length===0){a({title:"Erro",description:"Nenhum item para salvar.",variant:"destructive"});return}const v=c.map(r=>{const{id:E,created_at:C,updated_at:Z,...J}=r;return{...J,user_id:s.id,cnpj_loja:s.cnpj,nome_inventario:n,quantidade:parseFloat(r.quantidade)||0,estoque_inicial:parseFloat(r.estoque_inicial)||0,compras:parseFloat(r.compras)||0,outras_entradas:parseFloat(r.outras_entradas)||0,vendas:parseFloat(r.vendas)||0,outras_saidas:parseFloat(r.outras_saidas)||0,estoque_fisico_contado:parseFloat(r.estoque_fisico_contado)||0,custo_medio_unitario:parseFloat(r.custo_medio_unitario)||0,estoque_calculado:parseFloat(r.estoque_calculado)||0,divergencia:parseFloat(r.divergencia)||0,divergencia_valor:parseFloat(r.divergencia_valor)||0,percentual_quebra:parseFloat(r.percentual_quebra)||0}});try{const{error:r}=await P.from("inventario_fisico").insert(v);if(r)throw r;a({title:"Inventário Salvo!",description:`O inventário "${n}" foi salvo com sucesso.`}),o(!1)}catch(r){a({title:"Erro ao Salvar Inventário",description:r.message,variant:"destructive"})}},B=async()=>{if(s){t(!0),f(!0);try{const{data:n,error:v}=await P.from("inventario_fisico").select("nome_inventario").eq("user_id",s.id).eq("cnpj_loja",s.cnpj).not("nome_inventario","is",null);if(v)throw v;const r=[...new Set(n.map(E=>E.nome_inventario))];_(r)}catch(n){a({title:"Erro ao buscar inventários",description:n.message,variant:"destructive"})}finally{t(!1)}}},V=async n=>{if(s){p(!0),f(!1);try{const{data:v,error:r}=await P.from("inventario_fisico").select("*").eq("user_id",s.id).eq("cnpj_loja",s.cnpj).eq("nome_inventario",n).order("created_at",{ascending:!1});if(r)throw r;l(v||[]),A(n),a({title:"Inventário Carregado",description:`Exibindo o inventário "${n}".`})}catch(v){a({title:"Erro ao carregar inventário",description:v.message,variant:"destructive"})}finally{p(!1)}}};return u&&c.length===0&&s?e.jsxs("div",{className:"flex justify-center items-center h-64",children:[e.jsx(U,{size:48}),e.jsx("p",{className:"ml-3",children:"Carregando..."})]}):!s&&!u?e.jsx("div",{className:"text-center py-10",children:e.jsx("p",{className:"text-red-500",children:"Usuário não autenticado."})}):e.jsxs("div",{className:"space-y-6 pb-16",children:[e.jsx("h1",{className:"text-3xl font-bold text-gradient-brand",children:"Inventário Físico e Análise de Quebras"}),e.jsxs("p",{className:"text-muted-foreground",children:["Inventário carregado: ",e.jsx("span",{className:"font-semibold text-primary",children:x})]}),e.jsx(Oe,{currentUser:s,setItensInventario:l,onFileUploadUnificado:q,onSaveInventario:()=>o(!0),onOpenSearchModal:B,itensInventario:c}),e.jsx(Te,{itensInventario:c}),e.jsx(Re,{itensInventario:c,setItensInventario:l,loading:u,currentUser:s,fetchInventario:N,handleUpdateItemAnalise:Q,calcularAnaliseQuebraItem:g,handleSaveItemAnalise:j}),e.jsx(Be,{open:i,setOpen:o,onConfirmSave:M}),e.jsx(Ve,{open:m,setOpen:f,inventarios:h,isLoading:I,onSelectInventario:V})]})};export{ma as default};
