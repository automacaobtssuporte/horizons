import{c as pe,B as L,r as f,F as H,E as R,A as he,j as e,G as P,H as k,I as $,K as V,M as X,C as M,S as N,U as _,L as ge}from"./index-a996d77c.js";import{S as z,a as B,b as W,c as q,e as U,f as Y,d as A}from"./select-c1f59cc1.js";import{u as D,w as fe}from"./xlsx-81fdaaba.js";import{E as ve}from"./jspdf.plugin.autotable-234c2e89.js";import{B as Q}from"./bar-chart-3-b9a99bf5.js";import{D as Ne}from"./dollar-sign-0ce09540.js";import{C as je}from"./calculator-05e64e1e.js";import{T as be}from"./trending-up-62c7af95.js";import{P as Se}from"./percent-2438f5a2.js";import{P as Ce}from"./plus-circle-b044468d.js";import{T as Fe}from"./trash-2-99337be2.js";import{S as we}from"./save-d76e1658.js";import{F as ye}from"./file-spreadsheet-53adb39f.js";import{F as Ae}from"./file-text-fee5fbf7.js";import"./component-78adbb4d.js";import"./check-81dc6077.js";const Ee=pe("FileSearch",[["path",{d:"M4 22h14a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v3",key:"am10z3"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["path",{d:"M5 17a3 3 0 1 0 0-6 3 3 0 0 0 0 6z",key:"ychnub"}],["path",{d:"m9 18-1.5-1.5",key:"1j6qii"}]]),Pe=()=>{const{toast:d}=L(),[c,s]=f.useState(null),[g,j]=f.useState([]),[p,o]=f.useState([]),[a,i]=f.useState(!1);f.useEffect(()=>{const l=localStorage.getItem(H);l&&s(JSON.parse(l))},[]);const t=f.useCallback(async()=>{if(!(!c||!c.id)){i(!0);try{const{data:l,error:x}=await R.from("notas_fiscais").select("id, numero_nota, data_nota, items").eq("user_id",c.id).order("data_nota",{ascending:!1});if(x)throw x;j(l||[])}catch(l){d({title:"Erro ao buscar notas",description:l.message,variant:"destructive"})}finally{i(!1)}}},[c,d]),r=f.useCallback(async()=>{if(!(!c||!c.id))try{const{data:l,error:x}=await R.from("simulacoes_precos").select("id, nome_simulacao, data_simulacao, itens_simulacao, observacoes").eq("user_id",c.id).eq("cnpj_empresa",c.cnpj).order("created_at",{ascending:!1});if(x)throw x;o(l||[])}catch(l){console.warn("Erro ao buscar simulações salvas:",l)}},[c]);return f.useEffect(()=>{t(),r()},[t,r]),{notasFiscais:g,simulacoesSalvas:p,loadingNotas:a,reloadSimulacoesSalvas:r}},Ve=()=>{const{toast:d}=L(),c=(o,a)=>{const i=parseFloat(o),t=parseFloat(a);return!isNaN(i)&&!isNaN(t)&&t>0?((t-i)/t*100).toFixed(2)+"%":"N/A"},s=(o,a)=>{const i=parseFloat(o),t=parseFloat(a);return!isNaN(i)&&!isNaN(t)&&t>0?(i*t).toFixed(2):"N/A"},g=(o,a,i)=>{const t=parseFloat(o),r=parseFloat(a),l=parseFloat(i);return!isNaN(t)&&!isNaN(r)&&!isNaN(l)&&t>0&&r>0?(t*r*(l/100)*t).toFixed(2):"0"};return{calcularMargemAtual:c,calcularTotalVendaAtual:s,calcularNovoCusto:g,calcularDashboardMargem:o=>{const a=o.filter(x=>x.codigo||x.nome&&parseFloat(x.totalVenda)>0&&parseFloat(x.novoCusto)>0);if(a.length===0)return{receitaTotalEstimada:0,custoTotalEstimado:0,lucroTotalEstimado:0,margemLucroPercentual:0,itensAnalisados:0};const i=a.reduce((x,u)=>x+parseFloat(u.totalVenda||0),0),t=a.reduce((x,u)=>x+parseFloat(u.novoCusto||0),0),r=i-t,l=i>0?r/i*100:0;return{receitaTotalEstimada:i.toFixed(2),custoTotalEstimado:t.toFixed(2),lucroTotalEstimado:r.toFixed(2),margemLucroPercentual:l.toFixed(2),itensAnalisados:a.length}},processarItemChange:(o,a,i)=>{const t={...o,[a]:i},r=parseFloat(t.custoAtual),l=parseFloat(t.peso),x=u=>{if(t.novoPrecoVenda=u.toFixed(2),r>0?t.markup=((u-r)/r*100).toFixed(2):t.markup="inf",u>0?t.novaMargemCalculada=((u-r)/u*100).toFixed(2):t.novaMargemCalculada="0.00",!isNaN(l)&&l>0){const n=u*l;t.totalVenda=n.toFixed(2),t.novoCusto=g(l,u,100)}};if(a==="novaMargem"&&t.novaMargem&&!isNaN(r)){const u=parseFloat(t.novaMargem)/100;if(u>=0&&u<1){const n=r/(1-u);x(n),t.precoOferta=""}else t.novoPrecoVenda="",t.novaMargemCalculada="",t.markup="",t.totalVenda="",t.novoCusto="",u>=1&&d({title:"Margem Inválida",description:"Nova margem deve ser menor que 100%.",variant:"destructive"})}else if(a==="precoOferta"&&t.precoOferta&&!isNaN(r)){const u=parseFloat(t.precoOferta);x(u),t.novaMargem=""}else if(a==="peso"&&t.novoPrecoVenda&&!isNaN(l)){const u=parseFloat(t.novoPrecoVenda);if(!isNaN(u)&&l>0){const n=u*l;t.totalVenda=n.toFixed(2),t.novoCusto=g(l,u,100)}else t.totalVenda="",t.novoCusto=""}return t}}},Te=(d,c)=>{const s=new ve,g=[59,130,246],j=[55,65,81],p=[249,250,251],o=[34,197,94];s.setFillColor(...g),s.rect(0,0,210,25,"F"),s.setTextColor(255,255,255),s.setFontSize(18),s.setFont("helvetica","bold"),s.text("Simulação de Preços de Venda",20,16),s.setTextColor(...j),s.setFontSize(10),s.text(`Gerado em: ${new Date().toLocaleDateString("pt-BR")} às ${new Date().toLocaleTimeString("pt-BR")}`,150,22);let a=35;s.setFontSize(14),s.setFont("helvetica","bold"),s.text("Dados da Simulação",20,a),a+=10;const i=[["Nome da Simulação",d.nomeSimulacao||"N/A"],["Data da Simulação",d.dataSimulacao||"N/A"],["CNPJ da Empresa",d.cnpjEmpresa||"N/A"],["Nome da Empresa",d.nomeEmpresa||"N/A"],["Observações",d.observacoes||"Nenhuma observação"]];s.autoTable({startY:a,head:[["Item","Valor"]],body:i,theme:"grid",headStyles:{fillColor:g,textColor:[255,255,255]},alternateRowStyles:{fillColor:p},margin:{left:20,right:20},styles:{fontSize:10}}),a=s.lastAutoTable.finalY+15,a>250&&(s.addPage(),a=20),s.setFontSize(14),s.setFont("helvetica","bold"),s.text("Detalhes da Simulação de Preços",20,a),a+=10;const t=["Código","Nome","Peso (kg)","Custo Atual (R$)","Preço Atual (R$/kg)","Total Atual (R$)","Margem Atual","Novo Preço (R$/kg)","Total Venda (R$)","Novo Custo (R$)","Nova Margem"],r=c.map(h=>[h.codigo||"",h.nome||"",h.peso||"0",h.custoAtual||"0",h.precoVendaAtual||"0",h.totalVendaAtual||"0",h.margemAtual||"N/A",h.novoPrecoVenda||"0",h.totalVenda||"0",h.novoCusto||"0",h.novaMargemCalculada?h.novaMargemCalculada+"%":"N/A"]);s.autoTable({startY:a,head:[t],body:r,theme:"grid",headStyles:{fillColor:g,textColor:[255,255,255]},alternateRowStyles:{fillColor:p},margin:{left:20,right:20},styles:{fontSize:8},columnStyles:{0:{cellWidth:15},1:{cellWidth:22},2:{cellWidth:12},3:{cellWidth:16},4:{cellWidth:16},5:{cellWidth:16},6:{cellWidth:14},7:{cellWidth:16},8:{cellWidth:16},9:{cellWidth:16},10:{cellWidth:14}}}),a=s.lastAutoTable.finalY+15,a>250&&(s.addPage(),a=20),s.setFontSize(14),s.setFont("helvetica","bold"),s.text("Dashboard de Margem e Lucratividade",20,a),a+=10;const l=c.length,x=c.reduce((h,w)=>h+(parseFloat(w.peso)||0),0),u=c.reduce((h,w)=>h+(parseFloat(w.totalVenda)||0),0),n=c.reduce((h,w)=>h+(parseFloat(w.novoCusto)||0),0),F=u-n,E=u>0?F/u*100:0,I=[["Total de Itens Simulados",l.toString()],["Peso Total (kg)",x.toFixed(2)],["Receita Total Estimada (R$)",u.toFixed(2)],["Custo Total Estimado (R$)",n.toFixed(2)],["Lucro Total Estimado (R$)",F.toFixed(2)],["Margem de Lucro (%)",E.toFixed(2)+"%"]];s.autoTable({startY:a,head:[["Indicador","Valor"]],body:I,theme:"grid",headStyles:{fillColor:o,textColor:[255,255,255]},alternateRowStyles:{fillColor:p},margin:{left:20,right:20},styles:{fontSize:10}}),a=s.lastAutoTable.finalY+15,a>250&&(s.addPage(),a=20),s.setFontSize(12),s.setFont("helvetica","bold"),s.text("Fórmulas Utilizadas",20,a),a+=8,s.setFontSize(10),s.setFont("helvetica","normal"),s.text("1. Novo Custo = (Quantidade × Preço de Venda) × Índice de Participação %",20,a),a+=6,s.text("2. Margem de Lucro = (Lucro ÷ Receita Total Estimada) × 100",20,a),a+=6,s.text("3. Total da Venda = Preço de Venda × Peso",20,a),a+=8,s.setFont("helvetica","bold"),s.text("Interpretação da Margem de Lucro:",20,a),a+=6,s.setFont("helvetica","normal"),s.text("• ≥ 30%: Excelente lucratividade",20,a),a+=5,s.text("• 15-29%: Boa lucratividade",20,a),a+=5,s.text("• < 15%: Atenção necessária",20,a);const T=s.internal.getNumberOfPages();for(let h=1;h<=T;h++)s.setPage(h),s.setFontSize(8),s.setTextColor(128,128,128),s.text(`${he} - Página ${h} de ${T}`,20,285),s.text(`Simulação gerada automaticamente em ${new Date().toLocaleDateString("pt-BR")}`,120,285);return s},_e=()=>{const{toast:d}=L(),c=JSON.parse(localStorage.getItem(H));return{salvarSimulacao:async(p,o,a,i)=>{if(!c||!c.id||!c.cnpj)return d({title:"Erro",description:"Usuário não autenticado.",variant:"destructive"}),{success:!1};if(!p.trim())return d({title:"Erro",description:"Nome da simulação é obrigatório.",variant:"destructive"}),{success:!1};if(a.length===0||a.every(t=>!t.codigo&&!t.nome))return d({title:"Erro",description:"Adicione pelo menos um item à simulação.",variant:"destructive"}),{success:!1};try{const t={user_id:c.id,cnpj_empresa:c.cnpj,nome_simulacao:p,data_simulacao:new Date().toISOString().split("T")[0],itens_simulacao:a.filter(l=>l.codigo||l.nome),observacoes:o};let r;if(i?r=await R.from("simulacoes_precos").update(t).eq("id",i).eq("user_id",c.id):r=await R.from("simulacoes_precos").insert([t]),r.error)throw r.error;return d({title:"Simulação Salva",description:i?"Simulação atualizada com sucesso!":"Simulação salva com sucesso!"}),{success:!0}}catch(t){return d({title:"Erro ao Salvar",description:t.message,variant:"destructive"}),{success:!1}}},exportarExcel:(p,o,a,i)=>{if(p.length===0||p.every(t=>!t.codigo&&!t.nome)){d({title:"Erro",description:"Nenhum item para exportar.",variant:"destructive"});return}try{const t=[["Código","Nome","Peso (kg)","Custo Atual (R$)","Preço Venda Atual (R$/kg)","Total Venda Atual (R$)","Margem Atual (%)","Nova Margem (%)","Preço Oferta (R$/kg)","Novo Preço Venda (R$/kg)","Total da Venda (R$)","Novo Custo (R$)","Nova Margem Calc. (%)"],...p.filter(n=>n.codigo||n.nome).map(n=>[n.codigo||"",n.nome||"",n.peso||"",n.custoAtual||"",n.precoVendaAtual||"",a(n.precoVendaAtual,n.peso),i(n.custoAtual,n.precoVendaAtual).replace("%",""),n.novaMargem||"",n.precoOferta||"",n.novoPrecoVenda||"",n.totalVenda||"",n.novoCusto||"",n.novaMargemCalculada||""])],r=D.aoa_to_sheet(t),l=D.decode_range(r["!ref"]);for(let n=l.s.r;n<=l.e.r;++n)for(let F=l.s.c;F<=l.e.c;++F){const E=D.encode_cell({c:F,r:n});r[E]&&n===0&&(r[E].s={font:{bold:!0},fill:{fgColor:{rgb:"CCCCCC"}}})}const x=D.book_new();D.book_append_sheet(x,r,"Simulação de Preços");const u=`Simulacao_Precos_${o||"Nova"}_${new Date().toISOString().split("T")[0]}.xlsx`;fe(x,u),d({title:"Excel Exportado",description:"Planilha baixada com sucesso!"})}catch(t){d({title:"Erro na Exportação",description:t.message,variant:"destructive"})}},exportarPDF:(p,o,a,i,t)=>{if(p.length===0||p.every(r=>!r.codigo&&!r.nome)){d({title:"Erro",description:"Nenhum item para exportar.",variant:"destructive"});return}try{const r={nomeSimulacao:o||"Simulação de Preços",dataSimulacao:new Date().toLocaleDateString("pt-BR"),observacoes:a,cnpjEmpresa:c.cnpj,nomeEmpresa:c.storeName},l=p.filter(n=>n.codigo||n.nome).map(n=>({...n,totalVendaAtual:i(n.precoVendaAtual,n.peso),margemAtual:t(n.custoAtual,n.precoVendaAtual)})),x=Te(r,l),u=`Simulacao_Precos_${o||"Nova"}_${new Date().toISOString().split("T")[0]}.pdf`;x.save(u),d({title:"PDF Exportado",description:"Relatório baixado com sucesso!"})}catch(r){d({title:"Erro na Exportação",description:r.message,variant:"destructive"})}}}},De=({dadosMargem:d})=>{const{receitaTotalEstimada:c,custoTotalEstimado:s,lucroTotalEstimado:g,margemLucroPercentual:j,itensAnalisados:p}=d,o=(r,l,x,u="",n="text-primary",F="bg-primary/10")=>e.jsx(X.div,{whileHover:{scale:1.02},transition:{type:"spring",stiffness:300},children:e.jsxs(P,{className:"glass-card hover-lift",children:[e.jsxs(k,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx($,{className:"text-sm font-medium text-muted-foreground",children:r}),e.jsx("div",{className:`p-2 rounded-lg ${F}`,children:x})]}),e.jsx(V,{children:e.jsxs("div",{className:`text-2xl font-bold ${n}`,children:[l," ",e.jsx("span",{className:"text-sm text-muted-foreground",children:u})]})})]})}),a=r=>parseFloat(r).toLocaleString("pt-BR",{style:"currency",currency:"BRL"}),i=r=>{const l=parseFloat(r);return l>=30?"text-green-600":l>=15?"text-yellow-600":"text-red-600"},t=r=>{const l=parseFloat(r);return l>=30?"bg-green-100":l>=15?"bg-yellow-100":"bg-red-100"};return e.jsxs(P,{className:"glass-card",children:[e.jsxs(k,{children:[e.jsxs($,{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"h-5 w-5 text-primary"}),"Dashboard de Margem e Lucratividade"]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Análise consolidada baseada na fórmula: ",e.jsx("strong",{children:"Margem = Lucro ÷ Receita Total Estimada"})]})]}),e.jsxs(V,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6",children:[o("Receita Total Estimada",a(c),e.jsx(Ne,{className:"h-4 w-4 text-blue-600"}),"","text-blue-600","bg-blue-100"),o("Custo Total Estimado",a(s),e.jsx(je,{className:"h-4 w-4 text-orange-600"}),"","text-orange-600","bg-orange-100"),o("Lucro Total Estimado",a(g),e.jsx(be,{className:"h-4 w-4 text-green-600"}),"",parseFloat(g)>=0?"text-green-600":"text-red-600",parseFloat(g)>=0?"bg-green-100":"bg-red-100"),o("Margem de Lucro",parseFloat(j).toFixed(2),e.jsx(Se,{className:"h-4 w-4"}),"%",i(j),t(j)),o("Itens Analisados",p,e.jsx(Q,{className:"h-4 w-4 text-purple-600"}),"","text-purple-600","bg-purple-100")]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(P,{className:"border-l-4 border-l-blue-500",children:e.jsxs(V,{className:"pt-4",children:[e.jsx("div",{className:"text-sm font-medium text-muted-foreground",children:"Fórmula do Novo Custo"}),e.jsx("div",{className:"text-lg font-semibold text-blue-600 mt-1",children:"(Quantidade × Preço de Venda) × Índice de Participação % × QUANTIDADE"})]})}),e.jsx(P,{className:"border-l-4 border-l-green-500",children:e.jsxs(V,{className:"pt-4",children:[e.jsx("div",{className:"text-sm font-medium text-muted-foreground",children:"Fórmula da Margem"}),e.jsx("div",{className:"text-lg font-semibold text-green-600 mt-1",children:"Lucro ÷ Receita Total Estimada × 100"})]})}),e.jsx(P,{className:"border-l-4 border-l-purple-500",children:e.jsxs(V,{className:"pt-4",children:[e.jsx("div",{className:"text-sm font-medium text-muted-foreground",children:"Interpretação da Margem"}),e.jsxs("div",{className:"text-sm mt-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("div",{className:"w-3 h-3 bg-green-500 rounded-full"}),e.jsx("span",{children:"≥ 30%: Excelente"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("div",{className:"w-3 h-3 bg-yellow-500 rounded-full"}),e.jsx("span",{children:"15-29%: Boa"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-red-500 rounded-full"}),e.jsx("span",{children:"< 15%: Atenção"})]})]})]})})]})]})]})},Me=({itensSimulacao:d,onAddItem:c,onItemChange:s,onRemoveItem:g,calcularTotalVendaAtual:j,calcularMargemAtual:p})=>e.jsxs(P,{className:"glass-card",children:[e.jsxs(k,{className:"flex flex-row items-center justify-between",children:[e.jsx($,{children:"Itens para Simulação"}),e.jsxs(M,{onClick:c,size:"sm",variant:"outline",className:"hover-lift",children:[e.jsx(Ce,{className:"mr-2 h-4 w-4"})," Adicionar Item Manualmente"]})]}),e.jsx(V,{children:d.length===0?e.jsxs("div",{className:"text-center py-10",children:[e.jsx(Ee,{className:"mx-auto h-12 w-12 text-muted-foreground mb-3"}),e.jsx("p",{className:"text-muted-foreground",children:"Nenhum item para simular."}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Adicione itens manualmente ou carregue de uma nota fiscal."})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full min-w-[1750px]",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b",children:[e.jsx("th",{className:"p-2 text-left text-sm font-semibold",children:"Cód."}),e.jsx("th",{className:"p-2 text-left text-sm font-semibold",children:"Nome"}),e.jsx("th",{className:"p-2 text-left text-sm font-semibold",children:"Peso (kg)"}),e.jsx("th",{className:"p-2 text-left text-sm font-semibold",children:"Custo Atual (R$)"}),e.jsx("th",{className:"p-2 text-left text-sm font-semibold",children:"Preço Venda Atual (R$/kg)"}),e.jsx("th",{className:"p-2 text-left text-sm font-semibold",children:"Total Venda Atual (R$)"}),e.jsx("th",{className:"p-2 text-left text-sm font-semibold",children:"Margem Atual"}),e.jsx("th",{className:"p-2 text-left text-sm font-semibold",children:"Nova Margem (%)"}),e.jsx("th",{className:"p-2 text-left text-sm font-semibold",children:"Preço Oferta (R$/kg)"}),e.jsx("th",{className:"p-2 text-left text-sm font-semibold bg-primary/10",children:"Novo Preço Venda (R$/kg)"}),e.jsx("th",{className:"p-2 text-left text-sm font-semibold bg-primary/10",children:"Total da Venda (R$)"}),e.jsx("th",{className:"p-2 text-left text-sm font-semibold bg-green-500/10",children:"Novo Custo (R$)"}),e.jsx("th",{className:"p-2 text-left text-sm font-semibold bg-primary/10",children:"Nova Margem Calc."}),e.jsx("th",{className:"p-2 text-left text-sm font-semibold bg-primary/10",children:"Markup"}),e.jsx("th",{className:"p-2 text-right text-sm font-semibold",children:"Ações"})]})}),e.jsx("tbody",{children:d.map(o=>e.jsxs(X.tr,{className:"border-b hover:bg-muted/10 transition-colors",initial:{opacity:0},animate:{opacity:1},children:[e.jsx("td",{className:"p-1",children:e.jsx(N,{className:"min-w-[80px] h-9 text-xs",value:o.codigo,onChange:a=>s(o.id,"codigo",a.target.value)})}),e.jsx("td",{className:"p-1",children:e.jsx(N,{className:"min-w-[150px] h-9 text-xs",value:o.nome,onChange:a=>s(o.id,"nome",a.target.value)})}),e.jsx("td",{className:"p-1",children:e.jsx(N,{className:"min-w-[80px] h-9 text-xs",type:"number",step:"0.01",value:o.peso,onChange:a=>s(o.id,"peso",a.target.value)})}),e.jsx("td",{className:"p-1",children:e.jsx(N,{className:"min-w-[100px] h-9 text-xs",type:"number",step:"0.01",value:o.custoAtual,onChange:a=>s(o.id,"custoAtual",a.target.value)})}),e.jsx("td",{className:"p-1",children:e.jsx(N,{className:"min-w-[100px] h-9 text-xs",type:"number",step:"0.01",value:o.precoVendaAtual,onChange:a=>s(o.id,"precoVendaAtual",a.target.value)})}),e.jsx("td",{className:"p-1",children:e.jsx(N,{className:"min-w-[100px] h-9 text-xs bg-muted/30",value:j(o.precoVendaAtual,o.peso),readOnly:!0,disabled:!0})}),e.jsx("td",{className:"p-1",children:e.jsx(N,{className:"min-w-[80px] h-9 text-xs bg-muted/30",value:p(o.custoAtual,o.precoVendaAtual),readOnly:!0,disabled:!0})}),e.jsx("td",{className:"p-1",children:e.jsx(N,{className:"min-w-[100px] h-9 text-xs",type:"number",step:"0.01",placeholder:"Ex: 30",value:o.novaMargem,onChange:a=>s(o.id,"novaMargem",a.target.value)})}),e.jsx("td",{className:"p-1",children:e.jsx(N,{className:"min-w-[100px] h-9 text-xs",type:"number",step:"0.01",placeholder:"Ex: 19.90",value:o.precoOferta,onChange:a=>s(o.id,"precoOferta",a.target.value)})}),e.jsx("td",{className:"p-1",children:e.jsx(N,{className:"min-w-[100px] h-9 text-xs bg-primary/20 font-semibold",value:o.novoPrecoVenda,readOnly:!0,disabled:!0})}),e.jsx("td",{className:"p-1",children:e.jsx(N,{className:"min-w-[100px] h-9 text-xs bg-primary/20 font-semibold",value:o.totalVenda,readOnly:!0,disabled:!0})}),e.jsx("td",{className:"p-1",children:e.jsx(N,{className:"min-w-[100px] h-9 text-xs bg-green-500/20 font-semibold",value:o.novoCusto,readOnly:!0,disabled:!0})}),e.jsx("td",{className:"p-1",children:e.jsx(N,{className:"min-w-[80px] h-9 text-xs bg-primary/20 font-semibold",value:o.novaMargemCalculada?o.novaMargemCalculada+"%":"N/A",readOnly:!0,disabled:!0})}),e.jsx("td",{className:"p-1",children:e.jsx(N,{className:"min-w-[80px] h-9 text-xs bg-primary/20 font-semibold",value:o.markup?o.markup+"%":"N/A",readOnly:!0,disabled:!0})}),e.jsx("td",{className:"p-1 text-right",children:e.jsx(M,{variant:"ghost",size:"icon",onClick:()=>g(o.id),className:"h-9 w-9 hover:bg-destructive/20",children:e.jsx(Fe,{className:"h-4 w-4 text-destructive"})})})]},o.id))})]})})})]}),Re=()=>{const{toast:d}=L(),[c,s]=f.useState(null),[g,j]=f.useState([]),[p,o]=f.useState(!1);f.useEffect(()=>{const i=localStorage.getItem(H);i&&s(JSON.parse(i))},[]);const a=f.useCallback(async()=>{if(!(!c||!c.id)){o(!0);try{const{data:i,error:t}=await R.from("desossas_registradas").select("id, numero_nota_fiscal, data_chegada, cortes_info, peso_inicial_boi, custo_total_carcaca").eq("user_id",c.id).order("data_chegada",{ascending:!1});if(t)throw t;j(i||[])}catch(i){d({title:"Erro ao buscar desossas",description:i.message,variant:"destructive"})}finally{o(!1)}}},[c,d]);return f.useEffect(()=>{a()},[a]),{desossasRegistradas:g,loadingDesossas:p}},C={id:Date.now(),codigo:"",nome:"",custoAtual:"",precoVendaAtual:"",novaMargem:"",precoOferta:"",novoPrecoVenda:"",novaMargemCalculada:"",markup:"",peso:"",totalVenda:"",novoCusto:""},Ze=()=>{const[d,c]=f.useState([C]),[s,g]=f.useState(""),[j,p]=f.useState(""),[o,a]=f.useState(!1),[i,t]=f.useState(""),[r,l]=f.useState(""),[x,u]=f.useState(""),{notasFiscais:n,simulacoesSalvas:F,loadingNotas:E,reloadSimulacoesSalvas:I}=Pe(),{desossasRegistradas:T,loadingDesossas:h}=Re(),{calcularMargemAtual:w,calcularTotalVendaAtual:O,calcularDashboardMargem:Z,processarItemChange:K}=Ve(),{salvarSimulacao:ee,exportarExcel:ae,exportarPDF:te}=_e(),se=m=>{if(g(m),p(""),!m){c([C]);return}const v=n.find(b=>b.id===m);if(v&&v.items){const b=v.items.map((S,y)=>({...C,id:Date.now()+y,codigo:S.codigoProduto||"",nome:S.descricao||"",custoAtual:S.valorUnitario||"",peso:S.quantidade||""}));c(b.length>0?b:[C])}else c([C])},oe=m=>{if(p(m),g(""),!m){c([C]);return}const v=T.find(b=>b.id===m);if(v&&v.cortes_info){const b=v.cortes_info.map((S,y)=>{const J=S.novoCustoKg||"",G=S.preco_venda_kg||"",xe=S.peso||"";return{...C,id:Date.now()+y,codigo:S.codigo_produto||`C${y+1}`,nome:S.nome||"",peso:String(xe),custoAtual:String(J),precoVendaAtual:String(G),novoPrecoVenda:String(G),totalVenda:String(S.receitaVendaCorte||""),novoCusto:String(J),novaMargemCalculada:String(S.margemLucro||"")}});c(b.length>0?b:[C])}else c([C])},re=m=>{if(u(m),!m){c([C]),t(""),l("");return}const v=F.find(b=>b.id===m);v&&(c(v.itens_simulacao.map(b=>({...C,...b}))||[C]),t(v.nome_simulacao||""),l(v.observacoes||""))},le=()=>{c([...d,{...C,id:Date.now()}])},ne=(m,v,b)=>{c(S=>S.map(y=>y.id===m?K(y,v,b):y))},ce=m=>{c(d.filter(v=>v.id!==m))},ie=async()=>{a(!0),(await ee(i,r,d,x)).success&&await I(),a(!1)},de=()=>{ae(d,i,O,w)},ue=()=>{te(d,i,r,O,w)},me=Z(d);return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex flex-col sm:flex-row justify-between items-center gap-4",children:e.jsx("h1",{className:"text-3xl font-bold text-gradient-brand",children:"Simulação de Preços de Venda"})}),e.jsx(De,{dadosMargem:me}),e.jsxs(P,{className:"glass-card",children:[e.jsx(k,{children:e.jsx($,{children:"Controles da Simulação"})}),e.jsxs(V,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4",children:[e.jsxs("div",{children:[e.jsx(_,{htmlFor:"nomeSimulacao",children:"Nome da Simulação"}),e.jsx(N,{id:"nomeSimulacao",value:i,onChange:m=>t(m.target.value),placeholder:"Ex: Simulação Janeiro 2024"})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"simulacaoSalva",children:"Carregar Simulação Salva"}),e.jsxs(z,{onValueChange:re,value:x,children:[e.jsx(B,{children:e.jsx(W,{placeholder:"Selecionar simulação..."})}),e.jsx(q,{children:e.jsxs(U,{children:[e.jsx(Y,{children:"Simulações Salvas"}),F.length===0&&e.jsx(A,{value:"no-sim",disabled:!0,children:"Nenhuma simulação salva"}),F.map(m=>e.jsxs(A,{value:m.id,children:[m.nome_simulacao," (",new Date(m.data_simulacao+"T00:00:00").toLocaleDateString("pt-BR"),")"]},m.id))]})})]})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"desossaSelect",children:"Carregar de Desossa"}),e.jsxs(z,{onValueChange:oe,value:j,children:[e.jsx(B,{children:e.jsx(W,{placeholder:"Selecionar desossa..."})}),e.jsx(q,{children:e.jsxs(U,{children:[e.jsx(Y,{children:"Desossas Registradas"}),h&&e.jsx(A,{value:"loading",disabled:!0,children:"Carregando..."}),!h&&T.length===0&&e.jsx(A,{value:"no-desossa",disabled:!0,children:"Nenhuma desossa encontrada"}),T.map(m=>e.jsxs(A,{value:m.id,children:["NF ",m.numero_nota_fiscal," - ",new Date(m.data_chegada+"T00:00:00").toLocaleDateString("pt-BR")]},m.id))]})})]})]}),e.jsxs("div",{children:[e.jsx(_,{htmlFor:"notaSelect",children:"Carregar de Nota Fiscal"}),e.jsxs(z,{onValueChange:se,value:s,children:[e.jsx(B,{children:e.jsx(W,{placeholder:"Selecionar nota..."})}),e.jsx(q,{children:e.jsxs(U,{children:[e.jsx(Y,{children:"Notas Fiscais"}),E&&e.jsx(A,{value:"loading",disabled:!0,children:"Carregando..."}),!E&&n.length===0&&e.jsx(A,{value:"no-nota",disabled:!0,children:"Nenhuma nota encontrada"}),n.map(m=>e.jsxs(A,{value:m.id,children:["NF ",m.numero_nota," (",new Date(m.data_nota+"T00:00:00").toLocaleDateString("pt-BR"),")"]},m.id))]})})]})]}),e.jsxs("div",{className:"md:col-span-1",children:[e.jsx(_,{htmlFor:"observacoes",children:"Observações"}),e.jsx(N,{id:"observacoes",value:r,onChange:m=>l(m.target.value),placeholder:"Observações sobre a simulação..."})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(M,{onClick:ie,disabled:o,className:"hover-lift",children:[o?e.jsx(ge,{className:"mr-2",size:16}):e.jsx(we,{className:"mr-2 h-4 w-4"}),x?"Atualizar":"Salvar"," Simulação"]}),e.jsxs(M,{onClick:de,variant:"outline",className:"hover-lift",children:[e.jsx(ye,{className:"mr-2 h-4 w-4"}),"Exportar Excel"]}),e.jsxs(M,{onClick:ue,variant:"outline",className:"hover-lift",children:[e.jsx(Ae,{className:"mr-2 h-4 w-4"}),"Exportar PDF"]})]})]})]}),e.jsx(Me,{itensSimulacao:d,onAddItem:le,onItemChange:ne,onRemoveItem:ce,calcularTotalVendaAtual:O,calcularMargemAtual:w})]})};export{Ze as default};
